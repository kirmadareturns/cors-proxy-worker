<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple VS Code Notes</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        :root {
            --sidebar-width: 260px;
            --activity-bar-width: 48px;
            --editor-bg: #1e1e1e;
            --sidebar-bg: #252526;
            --activity-bg: #333333;
            --status-bg: #007acc;
            --text-color: #cccccc;
            --active-color: #007acc;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--editor-bg);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .mono-font {
            font-family: Consolas, 'Courier New', monospace;
        }
        /* Custom scrollbar styles to match VS Code dark theme */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(90, 90, 90, 0.7);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .custom-scrollbar-y-only {
            overflow-y: auto;
            overflow-x: hidden;
        }
        /* Hide scrollbar for the tabs area */
        .tabs-container {
             scrollbar-width: none; /* Firefox */
             -ms-overflow-style: none;  /* IE and Edge */
        }
        .tabs-container::-webkit-scrollbar {
             display: none; /* Chrome, Safari, Opera */
        }
    </style>
</head>
<body class="antialiased">

    <!-- 1. TOP TITLE BAR -->
    <div class="h-[30px] w-full bg-slate-900 flex items-center justify-between px-2 text-[12px] border-b border-[#2b2b2b] shadow-lg">
        <div class="flex space-x-4 ml-2 text-[#999]">
           <span class="hover:text-white px-1 rounded cursor-default">File</span>
           <span class="hover:text-white px-1 rounded cursor-default">Edit</span>
           <span class="hover:text-white px-1 rounded cursor-default">View</span>
        </div>
        <div id="title-bar" class="text-white font-medium text-sm">VS Code Clone - Welcome</div>
        <div class="flex space-x-2">
           <div class="h-3 w-3 rounded-full bg-yellow-500 hover:scale-110 transition-transform cursor-pointer"></div>
           <div class="h-3 w-3 rounded-full bg-green-500 hover:scale-110 transition-transform cursor-pointer"></div>
        </div>
    </div>

    <!-- 2. MAIN LAYOUT -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- ACTIVITY BAR -->
        <div id="activity-bar" class="w-[var(--activity-bar-width)] bg-[var(--activity-bg)] flex flex-col items-center py-2 space-y-2 border-r border-[#2b2b2b] shrink-0">
            <!-- Icons rendered by JavaScript -->
        </div>

        <!-- SIDEBAR PANEL -->
        <div id="sidebar-panel" class="w-[var(--sidebar-width)] bg-[var(--sidebar-bg)] flex flex-col border-r border-[#1e1e1e] shrink-0 transition-all duration-200">
            
            <!-- Sidebar Title -->
            <div id="sidebar-title" class="h-[35px] flex items-center px-4 text-[11px] font-bold tracking-wide uppercase text-[#bbbbbb] mt-2 border-b border-[#303030]">
                EXPLORER
            </div>

            <!-- SIDEBAR CONTENT -->
            <div id="sidebar-content" class="flex-1 custom-scrollbar custom-scrollbar-y-only">
                <!-- Content injected here -->
            </div>
        </div>

        <!-- EDITOR AREA -->
        <div class="flex-1 flex flex-col bg-[var(--editor-bg)] overflow-hidden">
          
            <!-- TABS HEADER -->
            <div id="tabs-header" class="flex bg-[#2d2d2d] overflow-x-auto tabs-container border-b border-[#1e1e1e]">
                <!-- Tabs injected here -->
            </div>

            <!-- EDITOR CONTENT -->
            <div id="editor-container" class="flex-1 relative flex overflow-hidden">
                <!-- Editor/Welcome message injected here -->
                <div id="welcome-message" class="absolute inset-0 flex flex-col items-center justify-center text-[#3b3b3b] transition-opacity duration-300">
                    <svg class="w-32 h-32" fill="none" stroke="currentColor" stroke-width="0.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 011.5 1.5M10.5 6a1.5 1.5 0 00-1.5 1.5M3.75 6H7.5m3 1.5V11.25m3-4.5V12M12 2.25h3.75m-3 0h-3.75m2.25 0a1.5 1.5 0 011.5 1.5m-3 0a1.5 1.5 0 00-1.5 1.5M12 12V21M12 12V12"></path>
                    </svg>
                    <div class="mt-8 space-y-2 text-center">
                        <p class="text-[var(--text-color)] text-lg">Welcome to your Local VS Code Clone!</p>
                        <p class="text-[var(--text-color)] text-sm">Your files are saved directly in this browser's local storage.</p>
                        <button onclick="document.getElementById('file-menu-new-file').click()" class="mt-4 bg-[#007acc] text-white px-4 py-1 rounded hover:bg-[#006bbd] transition-colors shadow-md">Create New File</button>
                    </div>
                </div>
                
                <!-- Main Editor -->
                <div id="editor-wrapper" class="hidden absolute inset-0 flex flex-col">
                    <div id="editor-breadcrumbs" class="h-[22px] bg-[var(--editor-bg)] flex items-center px-4 text-[11px] text-[#888888] border-b border-[#3e3e42] shrink-0">
                         <!-- Breadcrumbs injected here -->
                    </div>
                    <div class="flex-1 relative flex mono-font text-[14px]">
                        <!-- Line Numbering -->
                        <div id="line-numbers" class="w-[45px] bg-[#1e1e1e] text-[#858585] text-right pr-3 pt-1 select-none leading-5 text-xs border-r border-[#2b2b2b] overflow-hidden custom-scrollbar-y-only shrink-0"></div>
                        
                        <!-- Textarea and Syntax Overlay -->
                        <div class="relative flex-1 h-full">
                            <!-- Syntax Overlay (for visual effect, must mirror textarea scroll) -->
                            <pre id="syntax-overlay" class="absolute inset-0 m-0 pt-1 px-2 pointer-events-none select-none leading-5" style="z-index: 5; color: transparent;"></pre>
                            
                            <!-- Main Textarea -->
                            <textarea 
                                id="main-editor" 
                                class="absolute inset-0 w-full h-full bg-transparent text-[#d4d4d4] resize-none focus:outline-none pt-1 px-2 leading-5 whitespace-pre custom-scrollbar custom-scrollbar-y-only" 
                                spellcheck="false"
                                style="caret-color: white; z-index: 10;"
                            ></textarea>
                            <div id="unsaved-indicator" class="absolute top-2 right-4 h-2 w-2 rounded-full bg-white opacity-0 transition-opacity z-20"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. STATUS BAR -->
    <div id="status-bar" class="h-[22px] bg-[var(--status-bg)] text-white flex items-center justify-between px-3 text-[11px] shrink-0">
        <div class="flex items-center space-x-4">
           <div class="flex items-center hover:bg-white/20 px-1 cursor-default rounded">
              <span id="status-git">local*</span>
           </div>
           <div class="flex items-center hover:bg-white/20 px-1 cursor-default rounded">
              <span id="status-messages">0 Problems</span>
           </div>
        </div>
        <div class="flex items-center space-x-4">
           <span id="status-line-col" class="cursor-default hover:bg-white/20 px-1 rounded">Ln 1, Col 1</span>
           <span id="status-lang" class="cursor-pointer hover:bg-white/20 px-1 rounded">TEXT</span>
        </div>
    </div>

    <script>
        const LS_KEY = 'vscode_clone_workspace_files_html';
        const generateId = () => Math.random().toString(36).substring(2, 9);

        // --- GLOBAL STATE ---
        let files = [];
        let openTabs = [];
        let activeTabId = null;
        let sidebarView = 'explorer';
        let isFileDirty = false;
        let isRenaming = null; // file id being renamed

        // --- DOM REFERENCES ---
        const $activityBar = document.getElementById('activity-bar');
        const $sidebarTitle = document.getElementById('sidebar-title');
        const $sidebarContent = document.getElementById('sidebar-content');
        const $tabsHeader = document.getElementById('tabs-header');
        const $editorContainer = document.getElementById('editor-container');
        const $welcomeMessage = document.getElementById('welcome-message');
        const $editorWrapper = document.getElementById('editor-wrapper');
        const $mainEditor = document.getElementById('main-editor');
        const $syntaxOverlay = document.getElementById('syntax-overlay');
        const $lineNumbers = document.getElementById('line-numbers');
        const $titleBar = document.getElementById('title-bar');
        const $statusBarLineCol = document.getElementById('status-line-col');
        const $statusBarLang = document.getElementById('status-lang');
        const $unsavedIndicator = document.getElementById('unsaved-indicator');
        const $editorBreadcrumbs = document.getElementById('editor-breadcrumbs');

        // --- UTILS ---

        const getLanguageFromExt = (name) => {
            if (name.endsWith('.js') || name.endsWith('.jsx') || name.endsWith('.ts')) return 'javascript';
            if (name.endsWith('.md')) return 'markdown';
            if (name.endsWith('.json')) return 'json';
            return 'plaintext';
        };
        
        const getFileIcon = (name) => {
            const lang = getLanguageFromExt(name);
            switch(lang) {
                case 'javascript':
                    return '<svg class="w-4 h-4 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-4h-2v-2h4v6zm4 0h-2v-6h2v6zm-4-10H7v-2h4v2zm2 0h-2v-2h2v2z"/></svg>'; // JS Icon (Simplified)
                case 'markdown':
                    return '<svg class="w-4 h-4 text-blue-400 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.018A12.012 12.012 0 0112 20.713 12.013 12.013 0 012.382 7.287m17.636 6.33-4.757-4.757m0 0l-4.757-4.757"/></svg>'; // Checkmark/Doc Icon
                case 'json':
                    return '<svg class="w-4 h-4 text-purple-400 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15h4v2h-4v-2zm-2-8h8v-2h-8v2zm0 4h8v-2h-8v2z"/></svg>'; // Bracket Icon
                default:
                    return '<svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'; // Generic File Icon
            }
        };

        const getFolderIcon = (isOpen) => {
            return `<svg class="w-4 h-4 text-blue-400 mr-1.5 transition-transform duration-150 ${isOpen ? 'rotate-90' : ''}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>`;
        };

        const getFolderNodeIcon = (isOpen) => {
            return `<svg class="w-4 h-4 text-blue-400 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>`;
        };

        // --- DATA PERSISTENCE (Local Storage) ---

        const loadFiles = () => {
            try {
                const storedFiles = localStorage.getItem(LS_KEY);
                if (storedFiles) {
                    files = JSON.parse(storedFiles);
                } else {
                    files = [
                        { id: generateId(), name: 'notes', type: 'folder', parentId: null, content: '', isOpen: true },
                        { id: generateId(), name: 'README.md', type: 'file', parentId: null, content: '# My Local Notes App\n\nThis simple app is built with pure HTML, CSS (Tailwind), and JavaScript for maximum portability. All your data is saved in your browser.', language: 'markdown' },
                        { id: generateId(), name: 'config.js', type: 'file', parentId: files[0]?.id || null, content: '/* Configuration file example */\nconst port = 3000;\nconst theme = "dark";', language: 'javascript' },
                    ];
                }
            } catch (e) {
                console.error("Could not load workspace from local storage:", e);
                // Fallback: If loading fails, use an empty array or default files.
                files = [];
            }
        };

        const saveFiles = () => {
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(files));
            } catch (e) {
                console.error("Could not save workspace to local storage:", e);
            }
        };

        // --- CORE APPLICATION LOGIC ---

        const getFile = (id) => files.find(f => f.id === id);

        const updateUI = () => {
            renderActivityBar();
            renderSidebar();
            renderTabs();
            renderEditor();
            renderStatusBar();
            saveFiles();
        };

        const toggleSidebar = (view) => {
            if (sidebarView === view) {
                // Toggle off if clicking the active view
                if ($sidebarPanel.style.width === '0px') {
                    $sidebarPanel.style.width = 'var(--sidebar-width)';
                } else {
                    $sidebarPanel.style.width = '0px';
                }
            } else {
                // Switch view and ensure open
                sidebarView = view;
                $sidebarPanel.style.width = 'var(--sidebar-width)';
                $sidebarTitle.textContent = view.toUpperCase();
            }
            updateUI();
        };

        // --- Activity Bar Rendering ---

        const renderActivityBar = () => {
            const activities = [
                { id: 'explorer', icon: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm0 2v12h16V6H4zM6 8h4v8H6V8z', title: 'Explorer' },
                { id: 'search', icon: 'M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z', title: 'Search' },
                { id: 'git', icon: 'M18 16.5c-1.6 0-3.1.9-4 2-1-.9-2.4-2-4-2s-3.1-.9-4-2c-1 .9-2.4 2-4 2v-3c1.6 0 3.1-.9 4-2s2.4-2 4-2 3.1.9 4 2 2.4 2 4 2v3z', title: 'Source Control' },
                { id: 'settings', icon: 'M12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-18c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm0 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z', title: 'Settings' },
            ];

            const html = activities.map(item => `
                <div 
                    class="w-full h-[48px] flex items-center justify-center cursor-pointer border-l-2 ${sidebarView === item.id ? 'border-white text-white' : 'border-transparent text-[#6e6e6e] hover:text-white'}"
                    onclick="toggleSidebar('${item.id}')"
                    title="${item.title}"
                >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="${item.icon}"/></svg>
                </div>
            `).join('');

            $activityBar.innerHTML = html;
        };

        // --- Sidebar Rendering (Explorer) ---

        const renderExplorer = () => {
            const rootNodes = files.filter(f => f.parentId === null).sort((a, b) => {
                if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                return a.name.localeCompare(b.name);
            });

            const renderNode = (node, depth) => {
                const paddingLeft = depth * 12 + 10;
                const isActive = activeTabId === node.id;
                const isFolder = node.type === 'folder';

                // Renaming Input
                if (isRenaming === node.id) {
                    return `
                        <div style="padding-left: ${paddingLeft}px;" class="flex items-center py-[2px] cursor-pointer">
                            ${isFolder ? getFolderNodeIcon(node.isOpen) : getFileIcon(node.name)}
                            <input
                                id="rename-input-${node.id}"
                                type="text"
                                value="${node.name}"
                                class="bg-[#3c3c3c] border border-[#007acc] text-[13px] text-white outline-none px-1 w-2/3"
                                onblur="handleRename('${node.id}', this.value)"
                                onkeydown="if(event.key === 'Enter') handleRename('${node.id}', this.value)"
                                autofocus
                            />
                        </div>
                        ${isFolder && node.isOpen ? files.filter(f => f.parentId === node.id).map(f => renderNode(f, depth + 1)).join('') : ''}
                    `;
                }

                // Normal Node View
                const nodeHtml = `
                    <div 
                        id="node-${node.id}"
                        style="padding-left: ${paddingLeft}px;" 
                        class="flex items-center py-[2px] cursor-pointer group h-6 text-[13px] leading-6 truncate ${isActive ? 'bg-[#37373d] text-white' : 'text-[#cccccc] hover:bg-[#2a2d2e]'}"
                        data-id="${node.id}"
                        onclick="${isFolder ? `toggleFolder('${node.id}')` : `openFile('${node.id}')`}"
                        ondblclick="${isFolder ? '' : `openFile('${node.id}')`}"
                    >
                        <span class="mr-1.5 opacity-80 shrink-0 flex items-center" 
                              onclick="${isFolder ? '' : `event.stopPropagation()`}">
                            ${isFolder ? getFolderIcon(node.isOpen) : getFileIcon(node.name)}
                        </span>
                        <span class="truncate flex-1" onclick="${isFolder ? 'event.stopPropagation()' : ''}">${node.name}</span>
                        
                        <!-- Action Icons -->
                        <div class="flex space-x-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity pr-2">
                            <button title="Rename" class="hover:text-white" onclick="event.stopPropagation(); startRename('${node.id}')">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button title="Delete" class="hover:text-red-400" onclick="event.stopPropagation(); deleteFile('${node.id}')">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                `;

                if (isFolder && node.isOpen) {
                    const children = files.filter(f => f.parentId === node.id).sort((a, b) => {
                        if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                        return a.name.localeCompare(b.name);
                    }).map(f => renderNode(f, depth + 1)).join('');
                    return nodeHtml + children;
                }
                return nodeHtml;
            };

            const explorerHtml = `
                <div>
                    <div class="group px-4 py-2 flex items-center justify-between hover:bg-[#2a2d2e] cursor-pointer">
                        <div class="flex items-center text-xs font-bold text-blue-400">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                            LOCAL WORKSPACE
                        </div>
                        <div class="hidden group-hover:flex space-x-1">
                            <button id="file-menu-new-folder" title="New Folder" class="hover:text-white" onclick="createFile(null, true); event.stopPropagation()">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2zM12 9v6m-3-3h6"/></svg>
                            </button>
                            <button id="file-menu-new-file" title="New File" class="hover:text-white" onclick="createFile(null, false); event.stopPropagation()">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2zM12 18v-6m3 3h-6"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-1">
                        ${rootNodes.map(node => renderNode(node, 1)).join('')}
                    </div>
                </div>
            `;
            $sidebarContent.innerHTML = explorerHtml;
        };

        const renderSettings = () => {
            $sidebarContent.innerHTML = `
                <div class="p-4 text-sm space-y-4">
                    <div class="font-bold border-b border-gray-700 pb-2 text-white">Editor Settings (Mock)</div>
                    <p class="text-gray-400">This view is currently a placeholder to simulate the VS Code UI.</p>
                    <p class="text-gray-400">All data is saved locally in your browser's LocalStorage.</p>
                    <button class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition-colors" onclick="clearAllData()">Clear All Local Data</button>
                </div>
            `;
        };
        
        const renderSidebar = () => {
             if ($sidebarPanel.style.width === '0px') return;

             $sidebarTitle.textContent = sidebarView.toUpperCase();
             switch(sidebarView) {
                 case 'explorer':
                    renderExplorer();
                    break;
                 case 'settings':
                    renderSettings();
                    break;
                 case 'search':
                    // Simple Search Placeholder
                    $sidebarContent.innerHTML = `<div class="p-4 text-sm text-gray-400">
                        <input type="text" placeholder="Search files (Not implemented)" class="w-full bg-[#3c3c3c] border border-[#007acc] text-white px-2 py-1 rounded focus:outline-none"/>
                        <p class="mt-4">Search functionality is not implemented in this simple clone.</p>
                    </div>`;
                    break;
                 case 'git':
                    $sidebarContent.innerHTML = `<div class="p-4 text-sm text-gray-400">Source control functionality is not implemented in this simple clone.</div>`;
                    break;
             }
        };

        // --- Tab Rendering ---

        const renderTabs = () => {
            const html = openTabs.map(id => {
                const file = getFile(id);
                if (!file) return '';

                const isActive = activeTabId === id;
                const isDirty = isFileDirty && isActive;
                
                return `
                    <div 
                        class="group flex items-center min-w-[120px] max-w-[200px] h-[35px] px-3 text-[13px] border-r border-[#1e1e1e] cursor-pointer shrink-0 transition-colors duration-150
                        ${isActive ? 'bg-[var(--editor-bg)] text-white border-t-2 border-t-[var(--active-color)]' : 'bg-[#2d2d2d] text-[#969696] hover:bg-[#383838] border-t-2 border-t-transparent'}"
                        onclick="setActiveTab('${id}')"
                    >
                        ${getFileIcon(file.name)}
                        <span class="truncate flex-1">${file.name}</span>
                        ${isDirty ? `<div class="h-2 w-2 rounded-full bg-[#969696] mx-2"></div>` : ''}
                        <button 
                            class="ml-2 p-[2px] rounded-md hover:bg-[#4a4a4a] transition-opacity ${isActive || !isDirty ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}"
                            onclick="closeTab('${id}'); event.stopPropagation()"
                            title="Close"
                        >
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
            }).join('');
            $tabsHeader.innerHTML = html;
        };

        // --- Editor Rendering ---

        const renderEditor = () => {
            const activeFile = getFile(activeTabId);

            if (!activeFile) {
                $welcomeMessage.style.opacity = '1';
                $welcomeMessage.classList.remove('hidden');
                $editorWrapper.classList.add('hidden');
                $titleBar.textContent = 'VS Code Clone - Welcome';
                return;
            }

            $welcomeMessage.style.opacity = '0';
            $welcomeMessage.classList.add('hidden');
            $editorWrapper.classList.remove('hidden');

            $titleBar.textContent = `VS Code Clone - ${activeFile.name}${isFileDirty ? ' *' : ''}`;

            // Set content, attach listeners, and update language status
            $mainEditor.value = activeFile.content;
            $statusBarLang.textContent = activeFile.language.toUpperCase();
            
            // Breadcrumbs update
            $editorBreadcrumbs.innerHTML = `
                 <span>local-storage</span>
                 <svg class="w-3 h-3 mx-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                 <span class="text-white">${activeFile.name}</span>
            `;

            // Initial rendering of line numbers and syntax
            updateLineNumbers();
            updateSyntaxOverlay();
            updateStatusBar();
            updateDirtyState(isFileDirty);
        };

        // --- Status Bar Rendering ---

        const renderStatusBar = () => {
            const activeFile = getFile(activeTabId);
            if (activeFile) {
                 $statusBarLang.textContent = activeFile.language.toUpperCase();
            } else {
                 $statusBarLang.textContent = 'TEXT';
                 $statusBarLineCol.textContent = 'Ln 1, Col 1';
            }
        };

        // --- File System Operations ---

        const createFile = (parentId, isFolder) => {
            const id = generateId();
            const name = isFolder ? 'New Folder' : `untitled-${files.length}.txt`;
            const newNode = { 
                id, 
                name, 
                type: isFolder ? 'folder' : 'file', 
                parentId, 
                content: isFolder ? '' : `// New ${name} file`, 
                isOpen: true,
                language: getLanguageFromExt(name),
            };
            files.push(newNode);
            if (!isFolder) {
                openFile(id);
            }
            isRenaming = id; // Immediately start renaming after creation
            updateUI();
            
            // Focus on the new input element after rendering
            setTimeout(() => {
                const input = document.getElementById(`rename-input-${id}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        };

        const toggleFolder = (id) => {
            const file = getFile(id);
            if (file && file.type === 'folder') {
                file.isOpen = !file.isOpen;
                updateUI();
            }
        };

        const openFile = (id) => {
            const file = getFile(id);
            if (file && file.type === 'file') {
                if (!openTabs.includes(id)) {
                    openTabs.push(id);
                }
                activeTabId = id;
                isFileDirty = false; // Assume clean when opening
                updateUI();
            }
        };

        const closeTab = (id) => {
            openTabs = openTabs.filter(tabId => tabId !== id);
            if (activeTabId === id) {
                // Switch to the last tab if closing the active one
                activeTabId = openTabs.length > 0 ? openTabs[openTabs.length - 1] : null;
            }
            updateUI();
        };

        const updateFileContent = () => {
            const file = getFile(activeTabId);
            if (file) {
                file.content = $mainEditor.value;
                updateDirtyState(true); // Mark as dirty immediately on input
                updateUI();
                // Debounce save is handled by event listener
            }
        };

        const startRename = (id) => {
            isRenaming = id;
            updateUI();
            setTimeout(() => {
                const input = document.getElementById(`rename-input-${id}`);
                if (input) {
                    input.focus();
                    const lastDot = input.value.lastIndexOf('.');
                    if (lastDot > 0 && getFile(id).type === 'file') {
                        input.setSelectionRange(0, lastDot); // Select name, not extension
                    } else {
                        input.select();
                    }
                }
            }, 0);
        };

        const handleRename = (id, newName) => {
            const file = getFile(id);
            if (file && newName.trim() && newName.trim() !== file.name) {
                file.name = newName.trim();
                if (file.type === 'file') {
                    file.language = getLanguageFromExt(newName.trim());
                }
            }
            isRenaming = null;
            updateUI();
        };

        const deleteFile = (id) => {
            // Simple modal replacement
            const file = getFile(id);
            if (!file) return;

            if (!window.confirm(`Are you sure you want to delete "${file.name}"?`)) {
                return;
            }

            // Recursively collect IDs to delete
            const idsToDelete = [id];
            const getChildren = (parentId) => {
                files.filter(f => f.parentId === parentId).forEach(f => {
                    idsToDelete.push(f.id);
                    if (f.type === 'folder') getChildren(f.id);
                });
            };
            if (file.type === 'folder') {
                getChildren(id);
            }
            
            // Remove files from the array
            files = files.filter(f => !idsToDelete.includes(f.id));

            // Close any deleted files/tabs
            openTabs = openTabs.filter(tabId => !idsToDelete.includes(tabId));
            if (idsToDelete.includes(activeTabId)) {
                activeTabId = openTabs.length > 0 ? openTabs[openTabs.length - 1] : null;
            }

            updateUI();
        };
        
        const clearAllData = () => {
            if (window.confirm("WARNING: This will permanently delete ALL your notes from this browser. Are you sure?")) {
                localStorage.removeItem(LS_KEY);
                files = [];
                openTabs = [];
                activeTabId = null;
                alertMessage('All local data cleared. Reloading page.');
                setTimeout(() => window.location.reload(), 1500);
            }
        };

        // --- EDITOR FUNCTIONALITY ---

        const updateDirtyState = (dirty) => {
            isFileDirty = dirty;
            $unsavedIndicator.classList.toggle('opacity-0', !dirty);
            $titleBar.textContent = `VS Code Clone - ${getFile(activeTabId)?.name || 'Welcome'}${isFileDirty ? ' *' : ''}`;
            if (!dirty) saveFiles(); // Auto-save on clean/debounce end
        };

        // Editor Scroll and Content Sync
        const handleEditorScroll = () => {
            $lineNumbers.scrollTop = $mainEditor.scrollTop;
            $syntaxOverlay.scrollTop = $mainEditor.scrollTop;
        };

        const updateLineNumbers = () => {
            const content = $mainEditor.value;
            const lineCount = content.split('\n').length;
            const linesHtml = Array.from({ length: lineCount }, (_, i) => `<div>${i + 1}</div>`).join('');
            $lineNumbers.innerHTML = linesHtml;
        };

        const updateStatusBar = () => {
            const cursorStart = $mainEditor.selectionStart;
            const content = $mainEditor.value.substring(0, cursorStart);
            const line = content.split('\n').length;
            const column = cursorStart - content.lastIndexOf('\n') + (content.lastIndexOf('\n') === -1 ? 1 : 0);
            
            $statusBarLineCol.textContent = `Ln ${line}, Col ${column}`;
        };

        // Simplified Syntax Highlighter (Purely visual overlay)
        const syntaxHighlight = (code, lang) => {
            if (!code) return '';
            let html = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            if (lang === 'javascript' || lang === 'json') {
                // Keywords
                html = html.replace(/\b(const|let|var|function|return|class|if|else|switch|case|break|for|while|try|catch|async|await|this|null|undefined)\b/g, '<span style="color: #569cd6;">$1</span>');
                // Strings
                html = html.replace(/(['"`])(.*?)\1/g, '<span style="color: #ce9178;">$1$2$1</span>');
                // Numbers/Booleans
                html = html.replace(/\b(true|false)\b/g, '<span style="color: #569cd6;">$1</span>');
                html = html.replace(/\b(\d+)\b/g, '<span style="color: #b5cea8;">$1</span>');
                // Comments
                html = html.replace(/(\/\/.*)/g, '<span style="color: #6a9955;">$1</span>');
            } else if (lang === 'markdown') {
                // Headers
                html = html.replace(/^(#+)(.*)/gm, '<span style="color: #569cd6; font-weight: bold;">$1$2</span>');
                // Bold
                html = html.replace(/\*\*(.*?)\*\*/g, '<span style="font-weight: bold; color: #dcdcaa;">$1</span>');
            }
            
            // Preserve spaces and newlines
            html = html.replace(/ /g, '&nbsp;'); 
            return html;
        };
        
        const updateSyntaxOverlay = () => {
            const activeFile = getFile(activeTabId);
            if (!activeFile) return;
            const highlightedHtml = syntaxHighlight($mainEditor.value, activeFile.language);
            $syntaxOverlay.innerHTML = highlightedHtml;
            // The overlay must have the same line-height and font properties as the textarea
            $syntaxOverlay.className = $mainEditor.className.replace('text-[#d4d4d4]', 'text-transparent') + ' absolute inset-0 m-0 pt-1 px-2 pointer-events-none select-none leading-5 mono-font';
        };

        let debounceTimer;
        const handleEditorInput = (e) => {
            if (!activeTabId) return;
            
            updateFileContent();
            updateLineNumbers();
            updateSyntaxOverlay();
            updateStatusBar();

            // Debounce the setting of the dirty state to false (auto-save)
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateDirtyState(false); // Mark clean/saved
            }, 500);
        };
        
        const handleTabKey = (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = $mainEditor.selectionStart;
                const end = $mainEditor.selectionEnd;
                const tabSpace = '  '; // 2 spaces
                const newVal = $mainEditor.value.substring(0, start) + tabSpace + $mainEditor.value.substring(end);
                
                $mainEditor.value = newVal;
                // Manually trigger input processing to update content and UI
                handleEditorInput(e);

                // Restore cursor position
                $mainEditor.selectionStart = $mainEditor.selectionEnd = start + tabSpace.length;
            }
        };
        
        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            loadFiles();
            
            // Auto-open the first file if none are open
            if (files.length > 0 && !openTabs.length) {
                const firstFile = files.find(f => f.type === 'file');
                if (firstFile) openFile(firstFile.id);
            }
            
            updateUI();

            // Set up main editor listeners
            $mainEditor.addEventListener('input', handleEditorInput);
            $mainEditor.addEventListener('scroll', handleEditorScroll);
            $mainEditor.addEventListener('keyup', updateStatusBar);
            $mainEditor.addEventListener('keydown', handleTabKey);
            $mainEditor.addEventListener('click', updateStatusBar);
        });

        // Simple alert replacement for deletion
        const alertMessage = (message) => {
            const alertBox = document.createElement('div');
            alertBox.className = 'fixed top-4 right-4 bg-yellow-600 text-white p-3 rounded-lg shadow-xl z-[9999]';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        };
        
    </script>
</body>
</html>
