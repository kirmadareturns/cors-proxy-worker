<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Speed Reader Ultimate</title>
  <style>
    :root {
      --bg-color: #000000;
      --text-dim: #333333;
      --text-active: #FF9500; /* Orange */
      --line-color: #333333;
      --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background-color: var(--bg-color);
      font-family: var(--font-stack);
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* === HEADER === */
    .header {
      text-align: center;
      padding-top: 5vh;
      opacity: 1;
      flex: 0 0 auto;
    }
    .header h1 {
      font-size: 1rem;
      font-weight: 400;
      color: #666;
    }
    .header span {
      font-weight: 600;
      color: #fff;
    }

    /* === READER STAGE === */
    .stage {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .reticle {
      position: relative;
      width: min(90vw, 360px);
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 2px solid var(--line-color);
      border-bottom: 2px solid var(--line-color);
    }

    .reticle::before, .reticle::after {
      content: '';
      position: absolute;
      left: 35%;
      width: 2px;
      height: 10px;
      background-color: var(--line-color);
    }
    .reticle::before { top: 0; }
    .reticle::after { bottom: 0; }

    .word-display {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr auto 1fr; 
      align-items: baseline;
      font-size: clamp(3rem, 15vw, 4.5rem); 
      line-height: 1;
      user-select: none;
    }

    .word-display .left, .word-display .right, .word-display .pivot {
      color: var(--text-active);
      font-weight: 400;
    }

    .word-display .left { text-align: right; }
    .word-display .right { text-align: left; }
    .word-display .pivot { transform: translateX(-0.05ch); }

    #counter {
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #222;
      font-variant-numeric: tabular-nums;
    }

    /* === CONTROLS === */
    .controls {
      flex: 0 0 auto;
      width: 100%;
      padding: 20px;
      padding-bottom: 40px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
      opacity: 0.3; 
      transition: opacity 0.3s;
    }
    .controls:hover, .controls:active, .controls:focus-within { opacity: 1; }

    .main-btn {
      background: transparent;
      border: none;
      color: var(--text-active);
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      padding: 10px 20px;
    }
    
    .sub-controls {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
    }

    .text-btn {
      background: transparent;
      border: none;
      color: #444;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
    }
    .text-btn.active { color: var(--text-active); }

    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #444;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    input[type="number"] {
      background: transparent;
      border: none;
      border-bottom: 1px solid #333;
      color: #666;
      width: 40px;
      text-align: center;
      font-family: inherit;
      font-size: 0.9rem;
      border-radius: 0;
    }
    input:focus { color: #fff; outline: none; border-color: #666; }

    #textOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      z-index: 100;
      display: none;
      flex-direction: column;
      padding: 20px;
    }
    #textOverlay.show { display: flex; }
    textarea {
      flex: 1;
      background: #111;
      border: 1px solid #333;
      color: #ccc;
      padding: 15px;
      font-size: 16px; 
      resize: none;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .overlay-actions { display: flex; justify-content: space-between; }
  </style>
</head>
<body>

  <div class="header">
    <h1>Can you read at <span id="header-wpm">400</span> WPM?</h1>
  </div>

  <div class="stage">
    <div class="reticle">
      <div class="word-display" id="word-box">
        <div class="left">Ready</div><div class="pivot">?</div><div class="right"></div>
      </div>
    </div>
    <div id="counter">0 / 0</div>
  </div>

  <div class="controls">
    <button class="main-btn" id="playBtn">START</button>
    
    <div class="sub-controls">
      <div class="input-group">
        <span>WPM</span>
        <input type="number" id="wpmInput" value="400" step="50">
      </div>
      <button class="text-btn" id="ttsBtn">VOICE</button>
      <button class="text-btn" id="editBtn">EDIT TEXT</button>
    </div>
  </div>

  <div id="textOverlay">
    <textarea id="sourceText" placeholder="Paste text here..."></textarea>
    <div class="overlay-actions">
      <button class="text-btn" id="cancelText">CANCEL</button>
      <button class="text-btn active" id="saveText">SAVE</button>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
const wordBox = $('word-box');
const counter = $('counter');
const playBtn = $('playBtn');
const wpmInput = $('wpmInput');
const headerWpm = $('header-wpm');
const ttsBtn = $('ttsBtn');
const editBtn = $('editBtn');
const textOverlay = $('textOverlay');
const sourceText = $('sourceText');
const saveText = $('saveText');
const cancelText = $('cancelText');

const LS_TEXT = 'sr_text';
const LS_INDEX = 'sr_idx';
const LS_WPM = 'sr_wpm';

const DEFAULT_TEXT = "The average human reads at 230 words per minute, but your brain is capable of absorbing information five times faster. This method, known as Rapid Serial Visual Presentation, eliminates the time your eyes waste moving between words. By anchoring your focus on a single Optimal Recognition Point, you bypass the inner voice in your head that slows you down. You are no longer reading; you are downloading information directly into your mind. Ready to go faster?";

let words = [], currentIndex = 0, isPlaying = false, timer = null, ttsEnabled = false;

// Init
window.addEventListener('DOMContentLoaded', () => {
  const txt = localStorage.getItem(LS_TEXT) || DEFAULT_TEXT;
  sourceText.value = txt;
  parseText(txt);
  
  const idx = parseInt(localStorage.getItem(LS_INDEX) || '0');
  currentIndex = (idx < words.length) ? idx : 0;
  
  const wpm = localStorage.getItem(LS_WPM);
  if(wpm) wpmInput.value = wpm;
  headerWpm.textContent = wpmInput.value;
  
  renderWord(currentIndex);
});

function parseText(str) {
  words = str.trim().split(/\s+/).filter(Boolean);
}

function renderWord(idx) {
  if(!words.length) return;
  idx = Math.max(0, Math.min(idx, words.length - 1));
  
  const word = words[idx];
  let pIdx = Math.floor((word.length - 1) / 2);
  if(word.length > 5) pIdx = Math.floor(word.length / 2) - 1;

  const left = word.slice(0, pIdx);
  const pivot = word[pIdx];
  const right = word.slice(pIdx + 1);

  wordBox.innerHTML = `<div class="left">${left}</div><div class="pivot">${pivot}</div><div class="right">${right}</div>`;
  counter.innerText = `${idx + 1} / ${words.length}`;
  localStorage.setItem(LS_INDEX, idx);
}

function tick() {
  if (currentIndex >= words.length) { stop(); currentIndex = 0; renderWord(0); return; }
  renderWord(currentIndex);
  currentIndex++;
}

function play() {
  isPlaying = true;
  playBtn.textContent = "STOP";
  localStorage.setItem(LS_WPM, wpmInput.value);

  if(ttsEnabled) {
    const chunk = words.slice(currentIndex).join(' ');
    const u = new SpeechSynthesisUtterance(chunk);
    
    // === FIXED SPEED LOGIC ===
    // Web Speech API standard: Rate 1.0 ~= 180-200 WPM
    // Rate 2.0 ~= 400 WPM. Rate 10.0 = Max.
    // We calculate rate dynamically based on input.
    const calculatedRate = (parseInt(wpmInput.value) || 200) / 200;
    
    // We cap at 10 (browser limit) instead of 3, allowing for very fast reading.
    u.rate = Math.min(Math.max(calculatedRate, 0.5), 10.0);
    
    let offset = currentIndex;
    u.onboundary = e => { 
        if(e.name === 'word') { 
            renderWord(offset); 
            currentIndex = offset; 
            offset++; 
        } 
    };
    u.onend = stop;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  } else {
    // Normal Timer Logic
    const ms = 60000 / (parseInt(wpmInput.value) || 300);
    timer = setInterval(tick, ms);
  }
}

function stop() {
  isPlaying = false;
  playBtn.textContent = "START";
  clearInterval(timer);
  window.speechSynthesis.cancel();
}

playBtn.addEventListener('click', () => isPlaying ? stop() : play());

// === FIXED LISTENER ===
// Now restarts playback IMMEDIATELY on input change to apply new speed
wpmInput.addEventListener('input', e => {
  headerWpm.textContent = e.target.value;
  if(isPlaying) { 
    stop(); 
    play(); // Restart to apply new speed immediately
  }
});

ttsBtn.addEventListener('click', () => {
  ttsEnabled = !ttsEnabled;
  ttsBtn.classList.toggle('active', ttsEnabled);
  if(isPlaying) { stop(); play(); }
});

editBtn.addEventListener('click', () => {
  stop();
  textOverlay.classList.add('show');
  sourceText.value = words.join(' ');
});

saveText.addEventListener('click', () => {
  localStorage.setItem(LS_TEXT, sourceText.value);
  parseText(sourceText.value);
  currentIndex = 0;
  renderWord(0);
  textOverlay.classList.remove('show');
});

cancelText.addEventListener('click', () => textOverlay.classList.remove('show'));

</script>
</body>
</html>
