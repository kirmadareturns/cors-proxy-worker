<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiFractal | Adaptive Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&family=Inter:wght@300;400;500&display=swap');

        /* --- Base Variables --- */
        :root {
            --bg-color: #0a0a0f;
            --card-bg: #121216;
            --line-color: #333;
            --accent: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color);
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            width: 100vw; 
            height: 100vh;
            overflow: hidden; /* Desktop default */
        }

        /* --- DESKTOP LAYOUT (Default) --- */
        
        #viewport {
            width: 100%; height: 100%;
            overflow: hidden; cursor: grab;
            position: relative; touch-action: none;
        }
        
        #world {
            position: absolute;
            display: flex;
            padding: 50vh 50vw;
            transform-origin: 0 0;
            will-change: transform;
        }

        .node-wrapper { display: flex; align-items: center; gap: 80px; position: relative; }
        .children-stack { display: flex; flex-direction: column; gap: 40px; position: relative; }

        /* Desktop Connectors */
        .desktop-connector-h { position: absolute; left: -80px; top: 50%; width: 80px; height: 2px; background: var(--line-color); }
        .desktop-connector-v { position: absolute; left: -80px; top: 0; bottom: 0; width: 2px; background: var(--line-color); }
        
        /* Card Desktop */
        .card {
            width: 450px; height: 600px;
            background: var(--card-bg);
            border: 1px solid #2a2a30; border-radius: 12px;
            flex-shrink: 0; display: flex; flex-direction: column;
            position: relative; z-index: 10;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: border-color 0.2s;
        }
        .card:hover { border-color: #555; }

        /* --- MOBILE LAYOUT (Media Query Override) --- */
        @media (max-width: 768px) {
            body { 
                overflow-y: auto; /* Enable Native Scroll */
                overflow-x: hidden;
                height: auto;
                background: #000;
            }

            #viewport {
                position: static;
                width: 100%; height: auto;
                overflow: visible; cursor: default;
                padding-bottom: 100px;
            }

            #world {
                position: static !important; /* Disable absolute positioning */
                transform: none !important; /* Disable Zoom/Pan */
                display: flex;
                flex-direction: column; /* Vertical Stack */
                padding: 20px 10px; /* Small padding */
                width: 100%;
            }

            /* Change Tree Direction to Vertical */
            .node-wrapper {
                flex-direction: column; /* Children go below parent */
                align-items: stretch; /* Full width */
                gap: 15px;
                width: 100%;
                margin-bottom: 15px;
                position: relative;
            }

            .children-stack {
                flex-direction: column;
                gap: 15px;
                padding-left: 15px; /* Indentation for children */
                border-left: 2px solid #333; /* Visual Thread Line */
                margin-left: 10px;
            }

            /* Hide Desktop Connectors */
            .desktop-connector-h, .desktop-connector-v { display: none; }

            /* Mobile Card Styling */
            .card {
                width: 100% !important; /* Full Width */
                height: auto;
                max-height: 60vh; /* Collapsed view? No, let's auto height */
                min-height: 200px;
                box-shadow: none;
                border: 1px solid #222;
            }
            
            .card-header { padding: 12px 16px; background: #1a1a1f; }
            .card-title { font-size: 1rem; }
            
            /* Mobile Search Bar */
            .search-bar { width: 90% !important; top: 10px; }
            .nav-hint { display: none; } /* Hide hints on mobile */
        }

        /* --- Shared UI --- */
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; border-bottom: 1px solid #2a2a30;
            background: #18181c; border-radius: 12px 12px 0 0;
        }
        
        .card-body {
            flex: 1; overflow-y: auto; padding: 20px;
            font-size: 1rem; line-height: 1.6; color: #ccc;
            scrollbar-width: thin;
        }

        /* Typography */
        .wiki-text h2 { font-family: 'Space Grotesk'; font-size: 1.3rem; color: #fff; margin: 1.5rem 0 0.5rem 0; }
        .wiki-text a { color: var(--accent); text-decoration: none; border-bottom: 1px solid rgba(59,130,246,0.3); }
        .wiki-text p { margin-bottom: 1rem; }

        /* UI Layer */
        .search-bar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; background: rgba(20,20,25,0.95); backdrop-filter: blur(10px);
            border: 1px solid #333; border-radius: 30px;
            padding: 8px 20px; display: flex; align-items: center; gap: 10px;
            width: 400px; transition: all 0.3s;
        }
        
        .spinner { border: 2px solid #333; border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .suggestions {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: #1a1a20; border: 1px solid #333;
            border-radius: 12px; display: none; z-index: 99;
        }
        .suggestions.active { display: block; }
        .s-item { padding: 12px; border-bottom: 1px solid #222; color: #ccc; cursor: pointer; }
        
        /* Nav Hint */
        .nav-hint {
            position: fixed; bottom: 30px; left: 30px; 
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px;
            font-size: 0.8rem; color: #888; pointer-events: none; border: 1px solid #333;
        }

    </style>
</head>
<body>

    <div class="search-bar">
        <i class="ri-search-line text-gray-500"></i>
        <input type="text" id="searchInput" placeholder="Search knowledge..." class="bg-transparent border-none outline-none text-white w-full h-8 text-sm">
        <div id="loader" class="spinner hidden"></div>
    </div>
    <div id="suggestions" class="suggestions"></div>

    <div class="nav-hint">
        Desktop Mode: Drag to Pan â€¢ Scroll to Zoom
    </div>

    <div id="viewport">
        <div id="world"></div>
    </div>

    <script>
        // --- Core State ---
        const state = {
            isMobile: false,
            scale: 1,
            x: 0, y: 0,
            isDragging: false,
            startX: 0, startY: 0
        };

        const dom = {
            viewport: document.getElementById('viewport'),
            world: document.getElementById('world'),
            input: document.getElementById('searchInput'),
            suggestions: document.getElementById('suggestions')
        };

        const API = 'https://en.wikipedia.org/w/api.php?origin=*';

        // --- Device Detection & Layout Switching ---
        function checkDevice() {
            const wasMobile = state.isMobile;
            state.isMobile = window.innerWidth <= 768;

            if (state.isMobile !== wasMobile) {
                console.log(`Switched to ${state.isMobile ? 'Mobile' : 'Desktop'} Mode`);
                
                if (state.isMobile) {
                    // Reset Transform for Mobile
                    dom.world.style.transform = '';
                    dom.viewport.style.cursor = 'default';
                } else {
                    // Restore Desktop Defaults
                    state.x = (window.innerWidth / 2) - 225;
                    state.y = (window.innerHeight / 2) - 300;
                    state.scale = 1;
                    updateTransform();
                    dom.viewport.style.cursor = 'grab';
                }
            }
        }

        window.addEventListener('resize', checkDevice);
        checkDevice(); // Run on load

        // --- Desktop Navigation Engine ---
        function updateTransform() {
            if (state.isMobile) return; // Disable JS transforms on mobile
            dom.world.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
        }

        dom.viewport.addEventListener('wheel', (e) => {
            if (state.isMobile) return; // Native scroll on mobile

            const isOverCard = e.target.closest('.card-body');
            
            // Zoom (Ctrl + Wheel)
            if (e.ctrlKey) {
                e.preventDefault();
                const delta = e.deltaY * -0.001;
                state.scale = Math.min(Math.max(0.2, state.scale + delta), 4);
                updateTransform();
                return;
            }

            // Text Scroll
            if (isOverCard) return;

            // Pan
            e.preventDefault();
            state.x -= e.deltaX;
            state.y -= e.deltaY;
            updateTransform();
        }, { passive: false });

        dom.viewport.addEventListener('mousedown', (e) => {
            if (state.isMobile) return;
            if (e.target.closest('.card-body') || e.target.closest('.search-bar')) return;
            state.isDragging = true;
            state.startX = e.clientX - state.x;
            state.startY = e.clientY - state.y;
            dom.viewport.style.cursor = 'grabbing';
        });

        window.addEventListener('mouseup', () => {
            state.isDragging = false;
            if(!state.isMobile) dom.viewport.style.cursor = 'grab';
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.isDragging || state.isMobile) return;
            e.preventDefault();
            state.x = e.clientX - state.startX;
            state.y = e.clientY - state.startY;
            updateTransform();
        });

        // --- Wikipedia Logic ---

        async function fetchPage(title) {
            try {
                const res = await fetch(`${API}&action=parse&page=${encodeURIComponent(title)}&format=json&prop=text|displaytitle&redirects=1&disableeditsection=1&mobileformat=1`);
                const data = await res.json();
                return data.parse ? { title: data.parse.displaytitle, html: data.parse.text['*'] } : null;
            } catch (e) { return null; }
        }

        function createNode(title, parentStack = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'node-wrapper';

            const card = document.createElement('div');
            card.className = 'card';
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="font-bold text-white truncate pr-4 text-lg font-['Space_Grotesk']">${title}</span>
                    <i class="ri-close-line cursor-pointer hover:text-red-500 text-xl" onclick="removeNode(this)"></i>
                </div>
                <div class="card-body wiki-text">
                    <div class="flex flex-col items-center justify-center h-40 text-gray-500 gap-3">
                        <div class="spinner"></div>
                        <span class="text-xs">Loading...</span>
                    </div>
                </div>
            `;

            // Connectors (Desktop Only Visuals)
            if (parentStack) {
                const hLine = document.createElement('div'); hLine.className = 'desktop-connector-h';
                const vLine = document.createElement('div'); vLine.className = 'desktop-connector-v';
                wrapper.appendChild(hLine);
                // Note: vLine Logic is CSS based on .children-stack, simpler
            }

            wrapper.appendChild(card);

            if (!parentStack) {
                dom.world.innerHTML = '';
                dom.world.appendChild(wrapper);
                if(!state.isMobile) {
                    state.x = (window.innerWidth / 2) - 225;
                    state.y = (window.innerHeight / 2) - 300;
                    updateTransform();
                }
            } else {
                parentStack.appendChild(wrapper);
                // Mobile Auto-Scroll to new card
                if(state.isMobile) {
                    setTimeout(() => {
                        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }

            // Animate
            gsap.from(card, { opacity: 0, y: 20, duration: 0.4 });

            // Fetch
            fetchPage(title).then(data => {
                if(!data) {
                    card.querySelector('.card-body').innerHTML = '<div class="p-4 text-red-400">Page not found.</div>';
                    return;
                }
                
                const cleanHTML = DOMPurify.sanitize(data.html, { FORBID_TAGS: ['style','script','link','iframe'] });
                const body = card.querySelector('.card-body');
                body.innerHTML = cleanHTML;

                body.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if(href && href.startsWith('/wiki/')) {
                        link.onclick = (e) => {
                            e.preventDefault();
                            const nextTitle = href.replace('/wiki/', '').split('#')[0];
                            spawnChild(wrapper, nextTitle);
                        }
                    } else {
                        link.target = "_blank";
                    }
                });
            });
        }

        function spawnChild(parentNodeWrapper, title) {
            let stack = parentNodeWrapper.querySelector('.children-stack');
            if (!stack) {
                stack = document.createElement('div');
                stack.className = 'children-stack';
                parentNodeWrapper.appendChild(stack);
            }
            createNode(title, stack);
        }

        function removeNode(icon) {
            const wrapper = icon.closest('.node-wrapper');
            gsap.to(wrapper, { opacity: 0, height: 0, duration: 0.3, onComplete: () => wrapper.remove() });
        }

        // --- Search ---
        let debounce;
        dom.input.addEventListener('input', (e) => {
            clearTimeout(debounce);
            const q = e.target.value;
            if(q.length < 2) { dom.suggestions.classList.remove('active'); return; }
            
            document.getElementById('loader').classList.remove('hidden');
            debounce = setTimeout(async () => {
                const res = await fetch(`${API}&action=opensearch&search=${encodeURIComponent(q)}&limit=5&format=json`);
                const data = await res.json();
                document.getElementById('loader').classList.add('hidden');
                
                dom.suggestions.innerHTML = '';
                if(data[1].length) {
                    dom.suggestions.classList.add('active');
                    data[1].forEach(t => {
                        const div = document.createElement('div');
                        div.className = 's-item';
                        div.innerText = t;
                        div.onclick = () => {
                            createNode(t);
                            dom.suggestions.classList.remove('active');
                            dom.input.value = '';
                        }
                        dom.suggestions.appendChild(div);
                    });
                }
            }, 300);
        });

        window.addEventListener('click', (e) => {
            if(!e.target.closest('.search-bar')) dom.suggestions.classList.remove('active');
        });

        // Init
        createNode("Internet");

    </script>
</body>
</html>
